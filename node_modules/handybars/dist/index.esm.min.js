/**
 * 
 * Handybars
 * 
 * Copyright (c) 2020, Jocelyn Badgley
 * 
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 * 
 * Portions of the MIT licensed date-fns library are bundled with this
 * software. https://github.com/date-fns/date-fns#readme
 */

const e="{!MISSING!}",t=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;");function n(e,t,{hash:n=null}={}){const r=t?Object.create(t):{};return n&&Object.assign(r,n),r.this=e,r["@env"]=r,r["@value"]=e,r["@parent"]=t,r["@root"]=t["@root"]||r,r}function r(e,n=1){if(a(e)||function(e){return!1===e}(e))return 0===n?e:{value:"",safety:n};if(u(e)){if(0===n)return e;if(1===n)return{value:e,safety:n};if(2===n)return{value:e&&t(e)}}return y(e)&&w(e,"value")?0===n?e.value:{value:e.value,safety:n}:0===n?e:{value:e,safety:n}}function i(e,t,n=""){return t=T(t),{value:_(e,(e,n,i)=>r.up(t(e,n,i)).value).join(n)}}function s(e,t){throw t&&console.error(t),new Error(e)}function o(e){return"number"==typeof e&&!isNaN(e)}function u(e){return"string"==typeof e}function f(e){return"function"==typeof e}function c(e){return null===e}function l(e){return void 0===e}function a(e){return l(e)||c(e)}function h(e){return!l(e)&&!c(e)}function p(e){return e instanceof Map}function d(e){return e instanceof Set}r.NONE=2,r.WRAPPED=1,r.ESCAPED=2,r.down=e=>r(e,0),r.up=e=>r(e,2);const v=Array.isArray;function g(e){switch(typeof e){case"string":case"number":case"boolean":return!0;default:return!1}}function y(e){return!!e&&("object"==typeof e&&(!v(e)&&(e instanceof Object&&e.constructor===Object.prototype.constructor)))}function m(e){return O(e)?!!x(e):!!e}function w(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function b(e){return u(e)?e.toUpperCase():e}function E(e,t,n){if(a(e)||g(e))throw new TypeError("Input object was not a collection.");if(a(t)||""===t)return!1;if(o(t))t=[String(t)];else if(u(t)){if(w(e,t))return e[t];t=t.split(/[,[\].]+?/)}const r=t.filter(e=>h(e)&&""!==e).reduce((e,t)=>h(e)?e[t]:e,e);return l(r)||r===e?n:r}function k(e,t,n){if(a(t)||""===t)return!1;if(o(t))t=[String(t)];else if(u(t)){if(w(e,t))return e[t]=n,e;t=t.split(/[,[\].]+?/)}const r=t.length-1;return t.filter(e=>e||0===e).reduce((e,t,i)=>i===r?(e[t]=n,!0):y(e[t])||f(e[t])?e[t]:e[t]={},e),e}function O(e,t=!0){return t&&v(e)||t&&d(e)||p(e)||e&&("object"==typeof e||"function"==typeof e)}function x(e){return v(e)||u(e)?e.length:d(e)||p(e)?e.size:y(e)?Object.keys(e).length:!!e}function A(e){return v(e)?e:d(e)||p(e)?Array.from(e.values()):y(e)?Object.values(e):u(e)?e.split(/,\s*/):[e]}function $(e,t=null){if(!e)return!1;if(null===t?t=e=>e:f(T)||(t=T(t)),v(e)){let n=0;for(const r of e)if(t(r,n,n++))return!0;return!1}if(d(e)){let n=0;for(const r of e)if(t(r,n,n++))return!0;return!1}if(p(e)){let n=0;for(const[r,i]of e.entries())if(t(i,r,n++))return!0;return!1}if(y(e)){let n=0;for(const[r,i]of Object.entries(e))if(t(i,r,n++))return!0;return!1}return!!e}function T(e){if(a(e))return e=>e;if(f(e))return e;if(u(e))return t=>v(t)?t.includes(e):y(t)?t[e]:p(t)?t.get(e):d(t)?t.has(e):g(t)?t[e]:t===e;if(o(e))return t=>y(t)||v(t)?t[e]:p(t)?t.get(e):d(t)?t.has(e):o(t)?t===e:u(t)?Number(t)===e:t===e;if(v(e)){const[t,n]=e;return e=>e[t]===n}if(y(e)){const t=Object.entries(e).map(T);return e=>{for(const n of t)if(!n(e))return!1;return!0}}}function j(e){return function(e,t){if(!e)return{};const n=C(t,!0);if(v(e)){let t=0;for(const r of e)if(!n(r,t,t++))break}else if(d(e)){let t=0;for(const r of e)if(!n(r,t,t++))break}else if(p(e)){let t=0;for(const[r,i]of e.entries())if(!n(i,r,t++))break}else if(y(e)){let t=0;for(const[r,i]of Object.entries(e))if(!n(i,r,t++))break}return n.result()}(e,([e,t])=>[e,t])}function S(e,t,n){return u(e)||v(e)?e.slice(t,n):d(e)?new Set(Array.from(e.values()).slice(t,n)):p(e)?new Map(Array.from(e.entries()).slice(t,n)):y(e)?j((r=e,Object.entries(r)).slice(t,n)):e;var r}function _(e,t){return t=T(t),v(e)?e.map((e,n)=>t(e,n,n)):d(e)?Array.from(e,(e,n)=>t(e,n,n)):p(e)?Array.from(e.entries(),([e,n],r)=>t(n,e,r)):y(e)?Object.entries(e).map(([e,n],r)=>t(n,e,r)):u(e)?e.split().map((e,n)=>t(e,n,n)):[]}function C(e,t=!1){e=T(e);const n={};function r(r,i,s){const o=e(r,i,s)||[];if(t){if(!1===o)return!1;if(!o||!v(o))return!0;const[e,t]=o;if(a(e)||l(t))return!0;n[e]=t}else n[i]=o;return!0}return r.result=()=>n,r}function R(e,t=1/0){return t<=0?S(e):function(e,t,n){if(!f(t))throw new TypeError("Predicate must be a function");return v(e)?e.reduce((e,n,r)=>t(e,n,r,r),n):d(e)?Array.from(e).reduce((e,n,r)=>t(e,n,r,r),n):p(e)?Array.from(e.entries()).reduce((e,[n,r],i)=>t(e,r,n,i),n):y(e)?Object.entries(e).reduce((e,[n,r],i)=>t(e,r,n,i),n):void 0}(e,(e,n)=>e.concat(...O(n)?R(n,t-1):[n]),[])}const N=["WHITESPACE","TEXT","BLOCK_OPEN","BLOCK_STOP","BLOCK_START","BLOCK_CLOSE","ELSE","IDENTIFIER","LITERAL_NUM","LITERAL_STR","LITERAL_PRI","BRACKET_OPEN","BRACKET_CLOSE","PAREN_OPEN","PAREN_CLOSE","ASSIGNMENT"],L=e=>e>=48&&e<=57,I=function(...e){return $(e=e.flat().map(b),f)?1===(e=e.map(e=>{return f(e)&&e||(t=b(t=e),e=>b(e)===t);var t})).length?t=>e[0](t):t=>$(e,e=>e(t)):1===e.length?t=>b(t)===e[0]:t=>e.includes(b(t))}(e=>e>=65&&e<=90||e>=97&&e<=122,L,95,64,36,46),P=e=>45===e||46===e;class B{constructor(){this._type="Node"}evaluate(){return null}}class H extends B{constructor(e=""){super(),this.value=e,this._type="Text"}evaluate(){return{value:this.value}}}class U extends B{constructor({type:e,invoker:t,left:n,right:r,raw:i,...s}){super(),Object.assign(this,s),this.type=e,this.invoker=t||null,this.left=n||null,this.right=r||null,this.raw=i||!1,this._type="Block"}_descender(e,t,i){return e&&e.length?(s=t,o=i)=>(o===i&&s!==t&&(o=n(s,o)),function(e,t,n){if(!Array.isArray(e)||!e.length)return"";return{value:e.map(e=>r.up(e.evaluate(t,n))).filter(e=>""!==e.value).map(e=>e.value).join("")}}(e,s,o)):null}evaluate(e,t={}){const n=this._descender(this.left,e,t),i=this._descender(this.right,e,t),s=this.left&&this.left.length?this.left:null;var o=this.invoker?this.invoker.evaluate(e,t,{fn:n,inverse:i,children:s}):n&&n(e)||void 0;return this.raw?r(o):r.up(o)}}class M extends B{constructor(e={}){super(),Object.assign(this,e),this.arguments=e.arguments||[],this.hash=e.hash||{},this._type="Invocation"}evaluate(e,t={},{fn:i,inverse:s,children:o}={}){if(!this.arguments.length)return"";let[u,...c]=this.arguments;u=u.evaluate(e,t);const l=this.hashCount?function(e,t){if(!y(e))throw new Error("mapValues only works for simple objects, use mapReduce.");const n=C(t);let r=0;for(const[t,i]of Object.entries(e))if(!n(i,t,r++))break;return n.result()}(this.hash,n=>r.down(n.evaluate(e,t))):{};if(u&&f(u.evaluate)){const r=c.length?c[0]:e,i=n(r,t,{hash:l});return o&&(i["@partial-block"]=new U({type:"@partial-block",left:o})),u.evaluate(r,i)}return f(u)?(c=c.map(n=>r.down(n.evaluate(e,t))),u(...c,{ctx:e,env:t,fn:i,inverse:s,arguments:c,hash:l,resolve:n=>G(n,e,t)})):u&&i?i(e,t):!u&&s?s(e,t):i&&s?u?i(e,t):s(e,t):u}set(e,t){return this.hash[e]=t,this.hashCount=(this.hashCount||0)+1,this}}class K extends M{constructor(e){super(),this.arguments=e||[],this._type="Collection"}evaluate(e,t={}){return this.arguments.map(n=>n.evaluate(e,t))}}class D extends B{constructor(e,t){super(),this.target=e,this.critical=!!t,this._type="Identifier"}evaluate(e,t={}){return G(this.target,e,t,this.critical)}}class W extends B{constructor(e,t=[],n=!1){super(),this.path=e.split(/[,[\].]+?/).filter(Boolean).map(e=>new D(e)),this.refs=[],this.critical=n,this._type="CompoundIdentifier";for(const e of t)e.r?this.pushRef(e.r):this.pushTarget(e)}evaluate(t,n={}){const i=this.refs.map(e=>r.down(e.evaluate(t,n,this.critical))),s=this.path.map(e=>(void 0!==e.ref&&(e=i[e.ref]),e.evaluate?r.down(e.evaluate(t,n,this.critical)):e)),o=s.shift();if(!o)return;const u=E(o,s,e);return u===e?void 0:u}pushRef(e){this.refs.push(e),this.path.push({ref:this.refs.length-1})}pushTarget(e){this.path.push(e)}}class F extends B{constructor(e,t=10){super(),this.value=e,this.type=t,this._type="Literal"}evaluate(){return 8===this.type?parseFloat(this.value):this.value}}function G(t,n,r,i=!1){let o;if(!a(n)&&!g(n)&&(o=E(n,t,e))!==e)return o;if(!a(r)&&(o=E(r,t,e))!==e)return o;let u=r;for(;u=u["@parent"];){if(!a(u.this)&&!g(u.this)&&(o=E(u.this,t,e))!==e)return o;if(!a(u)&&(o=E(u,t,e))!==e)return o}i&&s(`Could not resolve "${t}"`)}function q(e,t){const n=function(e){const t=e.length-1;let n=!1,r=0,i=1,s=1;const o=[];let u=-1;function f(e,t=null,n=i,r=s){const u={type:e,contents:t,line:n,column:r};return o.push(u),u}const c=new SyntaxError;function l(e,{l:t=i,c:n=s,...r}={}){throw c.message=e+` (${t}:${n})`,console.dir(o),Object.assign(c,r,{line:t,column:n})}function a(){return{p:r,l:i,c:s}}function h(t){return e.startsWith(t,r)}function p(n=0){const i=r+n;if(!(i>t||i<0))return e.charCodeAt(i)}function d(n=1){const o=Math.min(t+1,Math.max(0,r+n));if(n>0)for(let t=r;t<o;t++)13===(u=e.charCodeAt(t))||10===u?(i++,s=1,13===u&&10===e.charCodeAt(r)&&r++):s++;var u;return r=o,r<=t}function v(){return r>t}function g(){if(v())return!1;for(const e of g.order)if(e())return!0;l(`Unknown token: ${e.substr(r,20)}…`)}return g.order=[function(){if(n||123!==p(0)||123!==p(1))return;n=!0;const e=f(4,"{{");return 123===p(2)?(e.raw=!0,e.contents="{{{",d(3)):d(2),35===p()?(f(2,"#"),d(1)):47===p()?(f(5,"/"),d(1)):(h("else")||h("ELSE"))&&(f(6,"else"),d(4)),!0},function(){if(n)return;let t=p();const{p:i,l:s,c:o}=a();do{if(123===t&&123===p(1))break;d()}while(t=p());return i!==r?(f(1,e.slice(i,r),s,o),!0):void 0},function(){if(!n)return;const{p:i,l:s,c:o}=a();let u;for(;r<=t&&(u=p(0))&&!(u>14&&32!==u&&160!==u);)d();return i!==r?(f(0,e.slice(i,r),s,o),!0):void 0},function(){let t=p();if(!n||L(t)||!I(t)||46===t)return;const{p:i,l:s,c:o}=a();for(d();(t=p())&&I(t);)d();if(i===r)return;const u=e.slice(i,r);return"true"===u?f(10,!0,s,o):"false"===u?f(10,!1,s,o):"null"===u?f(10,null,s,o):f(7,u,s,o),!0},function(){if(!n)return;let t=p();if(!L(t)&&!P(t))return;if(P(t)&&!L(p(1)))return;const{p:i,l:s,c:o}=a();let u=!1;do{if(45!==t){if(46===t){if(u)break;u=!0}else if(!L(t))break;d()}else{if(r!==i)break;d()}}while(t=p());return i!==r?(f(8,e.slice(i,r),s,o),!0):void 0},function(){let t=p();if(!n||!(e=>39===e||34===e)(t))return;const{p:i,l:s,c:o}=a(),u=t;for(d();t=p();)if(92!==t){if(t===u)return f(9,r-i==1?"":e.slice(i+1,r).replace(/\\(.)/,"$1"),s,o),d(),!0;d()}else d(2);l(`Unterminated string literal: ${e.substr(i,20)}…`,{l:s,c:o})},function(){if(n&&61===p())return f(15,"="),d(),!0},function(){if(n&&91===p())return f(11,"["),d(),!0},function(){if(n&&93===p())return f(12,"]"),d(),46===p()&&d(),!0},function(){if(n&&40===p())return f(13,"("),d(),!0},function(){if(n&&41===p())return f(14,")"),d(),46===p()&&d(),!0},function(){if(!n||125!==p(0)||125!==p(1))return;n=!1;const e=f(3,"}}");return 125===p(2)?(e.raw=!0,e.contents="}}}",d(3)):d(2),!0}],{get eof(){return v()},get current(){for(;u>=o.length&&!v();)g();return o[u]},readAll(){for(;g(););return o},reset(){return u=-1,this},next(){for(u++;u>=o.length&&!v();)g();return o[u]},peek(e=1){const t=u+e;for(;t>=o.length&&!v();)g();return o[t]}}}(e);let r,i,s=0;function o(e,t){if(n.eof)return;const o=n.peek();if(l(e)||!o||o.type===e)return i=o.contents,s++,r=n.next();t&&a(u(t)?t:`Expected ${e} but found ${N[o.type]}`,o)}function f(e,t=1){const r=n.peek(t);if(l(e)||!r||r.type===e)return r}const c=new SyntaxError;function a(e="Unexpected token: "+N[r.type],{line:n,column:i,...o}=r||{}){e+=n?` (${n}:${i})`:"",t&&(e+=`[Token ${s}]`);let u=c;throw t?u=new SyntaxError(e):c.message=e,Object.assign(u,o)}const h=e=>(t=r)=>t&&t.type===e,p=h(7),d=h(1),v=h(0),g=h(4),y=h(3),m=h(11),w=h(12),b=h(13),E=h(14),k=h(15),O=h(8),x=h(9),A=h(10),$=(e=r)=>O(e)||x(e)||A(e);function T(e=!1){const t=new M,n=t.arguments;let s=!1;do{if(n.length&&e&&(n[0].critical=!0),!v())if(p())f(11)?s?(t.set(s,j(i)),s=!1):n.push(j(i)):s?(t.set(s,new D(i)),s=!1):n.push(new D(i));else{if(y())return n.length>1&&(n[0].critical=!0),t;if(n.length||a(`Block helpers must start with a variable identifier, found "${r.contents}" (${N[r.type]})`),b())o(),s?(t.set(s,T(!0)),s=!1):n.push(T(!0));else if($())s?(t.set(s,new F(i,r.type)),s=!1):n.push(new F(i,r.type));else if(m())s?(t.set(s,S()),s=!1):n.push(S());else{if(s&&a(),E())return e||a(),t;if(k()){s=n.pop().target}else a()}}}while(o());return e&&a("Unexpected end of token stream, unclosed nested invocation."),t}function j(e){const t=new W(e);let n=!1;for(;o()&&!v();){if(w()){const e=f();if(m(e)||p(e))continue;break}if(p()){o(11)&&t.pushRef(j(i)),n?(n=!1,t.pushRef(new D(i))):t.pushTarget(i);const e=f();if(m(e)||w(e))continue;break}if(b())t.pushRef(T(!0));else if($())t.pushTarget(new F(i,r.type));else{if(!m())break;n=!0}}return t}function S(){const e=new K,t=e.arguments;for(;o();)if(!v()){if(w())return e;b()?t.push(T(!0)):p()?o(11)?t.push(j(i)):t.push(new D(i)):$()?t.push(new F(i,r.type)):m()?t.push(S()):a()}a("Unexpected end of token stream, unclosed collection.")}const _=function e(t){let n=!1;r?p()||a(`Block helpers must start with a variable identifier, found "${r.contents}" (${N[r.type]})`):n=!0;const s=new U({type:n?"ROOT":i,invoker:n?null:T(),left:[]});t&&(s.raw=t);let u=s.left;for(;o();)if(d())u.push(new H(i));else if(g()){const t=r.raw;if(o(2))o(),u.push(e(t));else if(o(6)){for(u.length||u.push(new H),u=s.right=[];o(0););o(3,`Expected }}, found "${r.contents}" (${N[r.type]})`)}else{if(o(5)){for(o(7,`The first argument of a block must be an identifier, found "${r.contents}" (${N[r.type]})`),i!==s.type&&a(`Expected {{/${s.type}}} but found {{/${i}}}`),u.length||u.push(new H);o(0););return o(3,`Expected }}, found "${r.contents}" (${N[r.type]})`),s}o(7)?u.push(new U({type:i,invoker:T(),raw:t})):a(`This shouldn't have happened. "${f().contents}" (${N[f().type]})`)}}else a(`Unexpected token while processing block children for {{#${s.type}}}: "${r.contents}" (${N[r.type]})`);return n||a(`Unexpected end of template, unclosed {{#${s.type}}}`),s}();return n.eof||a("There are still tokens left, how did we get here?"),_}function z(...t){if(t.length<3)throw new Error('Helper "get" needs a minimum of 3 arguments');const{fn:n,inverse:r}=t.pop(),i=t.shift();if(!i)return"";const s=E(i,t=1===t.length?t[0]:R(t),e);return s===e?r?r():"":n?n(s):s}function V(...e){const{ctx:t,fn:n,inverse:r}=e.pop(),i=e.shift(),s=e.length?i!==e[0]:function(e){return!m(e)}(i);return n?s?n(t):r&&r():s||""}const X={if:function(...e){if(e.length<1)throw new Error('Helper "if" needs a minimum of 1 arguments');const{ctx:t,fn:n,inverse:r}=e.pop(),i=e.shift(),s=e.length?i===e[0]:m(i);return n?s?n(t):r&&r():s||""},with:function(...e){const{env:t,fn:r,inverse:i,hash:s}=e.pop();if(!r&&!i)return"";if(!e.length)return"";const[o]=e,u=n(o,t,{hash:s});return m(o)?r(o,u):i&&i()},each:function(e,...t){const{env:r,fn:s,inverse:o,hash:u}=t.pop();return x(e)?s?function(e,t,r,s){var o=n(e,t,{hash:s});const u=x(e);return i(e,(e,t,n)=>(o.this=e,o["@value"]=e,o["@key"]=t,o["@index"]=n,o["@first"]=0===n,o["@last"]=n===u-1,r(e,o)))}(e,r,s,u):e:o?o():e},log:function(...e){const{env:t}=e.pop();e.length||(e=[t]),console.log(...e)},not:V,unless:V,has:function(...e){if(e.length<3)throw new Error('Helper "has" needs a minimum of 3 arguments');const{fn:t,inverse:n}=e.pop(),r=function(e,t){if(a(t)||""===t)return!1;o(t)?t=[String(t)]:u(t)&&(t=String.prototype.split.call(t,/[,[\].]+?/));let n=e;for(const e of t){if(a(n)||"object"!=typeof n&&f(n)||l(n[e]))return!1;n=n[e]}return!0}(e.shift(),e=1===e.length?e[0]:R(e));return t?r?t():n&&n():r||""},is:function(...e){if(e.length<3)throw new Error('Helper "is" needs a minimum of 2 arguments');const{fn:t,inverse:n}=e.pop(),r=e.shift(),i=e.includes(r);return t?i?t(this):n&&n(this):i||""},isNot:function(...e){if(e.length<3)throw new Error('Helper "isNot" needs a minimum of 2 arguments');const{fn:t,inverse:n}=e.pop(),r=e.shift();var i=-1===e.indexOf(r);return t?i?t():n&&n():i||""},all:function(...e){const{fn:t,inverse:n}=e.pop();if(!e.length)throw new Error('Helper "all" needs 1 parameter');const r=function(...e){let t;t=e.length>1?e:A(e[0]);let n=t.shift();for(const e of t){if(!m(n))return!1;n=e}return n}(...e);return t?r?t(r):n&&n(this):r||""},any:function(...e){const{fn:t,inverse:n}=e.pop();if(!e.length)throw new Error('Helper "any" needs 1 parameter');let r;r=e.length>1?e:A(e[0]);let i=!1;for(const e of r)if(m(e)){i=e;break}return t?i?t(i):n&&n():i||""},get:z,lookup:z};function J(e){return u(e)?q(e):e instanceof U?e:void s("Parse can only receive strings or a Handybars AST tree")}function Q(e,t){return u(e)?e=q(e):e instanceof U||s("Evaluate can only receive strings or a Handybars AST tree"),e.evaluate(t,X).value}export default function(e,t={}){const r=J(e),i={...X,...t};function s(e){const t=n(e,i);return r.evaluate(e,t).value}return s.set=(...e)=>(y(e[0])?Object.assign(i,...e):k(i,...e),s),s.setPartial=(e,t)=>k(i,e,q(t)),s}export{U as Block,K as Collection,W as CompoundIdentifier,D as Identifier,M as Invocation,F as Literal,H as Text,Q as evaluate,n as makeContext,J as parse,J as partial,r as safe,i as safeJoin};
